on:
  workflow_dispatch:
    inputs:
      title:
        description: "Patch title"
        required: true
        type: string
      scope:
        description: "Scope (doctrine|infra|ux|tooling)"
        required: false
        default: "doctrine"
        type: string
      master_file:
        description: "Master file path"
        required: false
        default: "MASTER.md"
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure repo structure
        run: |
          set -e
          mkdir -p patches tools
          if [ ! -f "${{ inputs.master_file }}" ]; then
            echo "# FUTILITY’S — CANONICAL MASTER" > "${{ inputs.master_file }}"
            echo "" >> "${{ inputs.master_file }}"
          fi
          if [ ! -f "HISTORY.md" ]; then
            echo "# History" > HISTORY.md
            echo "" >> HISTORY.md
          fi

      - name: Install patch tool
        run: |
          cat > tools/futility_patch.sh <<'BASH'
          #!/usr/bin/env bash
          set -euo pipefail
          PATCH_DIR="${PATCH_DIR:-patches}"
          MASTER_FILE="${MASTER_FILE:-MASTER.md}"
          HISTORY_FILE="${HISTORY_FILE:-HISTORY.md}"

          title="${1:-}"
          scope="${2:-doctrine}"
          [[ -z "$title" ]] && { echo "missing title"; exit 1; }

          slug="$(echo "$title" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g')"

          mkdir -p "$PATCH_DIR"
          max=0
          shopt -s nullglob
          for f in "$PATCH_DIR"/[0-9][0-9][0-9]-*.md; do
            n="$(basename "$f")"; n="${n%%-*}"
            [[ "$n" =~ ^[0-9]{3}$ ]] && ((10#$n>max)) && max=$((10#$n))
          done
          shopt -u nullglob
          num=$(printf "%03d" $((max+1)))

          patch_path="$PATCH_DIR/${num}-${slug}.md"
          date="$(date +%Y-%m-%d)"

          cat > "$patch_path" <<EOF
          # Patch ${num} — ${title}

          Date: ${date}
          Scope: ${scope}

          ## Context
          (What triggered this change?)

          ## Change
          (What is changing?)

          ## Affected Sections
          - ${MASTER_FILE} §...

          ## Rationale
          (Why this is better.)

          ## Deprecates / Replaces
          (What is now obsolete?)

          ## Rollback Plan
          (How to revert.)

          EOF

          # HISTORY.md append
          {
            echo "## ${date} — Patch ${num}: ${title}"
            echo ""
            echo "- Patch file: \`${patch_path}\`"
            echo "- Scope: ${scope}"
            echo ""
          } >> "$HISTORY_FILE"

          # MASTER.md Patch Index
          if ! grep -qE '^## Patch Index' "$MASTER_FILE"; then
            echo "" >> "$MASTER_FILE"
            echo "## Patch Index" >> "$MASTER_FILE"
            echo "" >> "$MASTER_FILE"
          fi
          echo "- Patch ${num}: ${title} (\`${patch_path}\`)" >> "$MASTER_FILE"

          echo "$patch_path" > .patch_created
          BASH
          chmod +x tools/futility_patch.sh

      - name: Create patch
        env:
          PATCH_DIR: patches
          MASTER_FILE: ${{ inputs.master_file }}
          HISTORY_FILE: HISTORY.md
        run: |
          tools/futility_patch.sh "${{ inputs.title }}" "${{ inputs.scope }}"

      -      - name: Create branch
        run: |
          set -e
          branch="patch/$(date +%Y%m%d)-$(cat .patch_created | sed 's#patches/##' | sed 's#.md##')"
          git checkout -b "$branch"
          echo "BRANCH=$branch" >> $GITHUB_ENV

      - name: Commit changes
        run: |
          set -e
          git config user.name "futility-bot"
          git config user.email "futility-bot@users.noreply.github.com"
          git add -A
          git commit -m "patch: ${{ inputs.title }}"
          git push --set-upstream origin "$BRANCH"

      - name: Open PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ env.BRANCH }}
          title: "Patch: ${{ inputs.title }}"
          body: |
            Automated patch creation.
            Scope: `${{ inputs.scope }}`
            Master: `${{ inputs.master_file }}`
